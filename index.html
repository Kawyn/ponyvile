<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <link rel="stylesheet" href="style.css" type="text/css" />

        <title>Ponyvile</title>
    </head>
    <body onload="Start();">

        <!-- World -->
        <div ondrop="drop(event)" id="plane" ondragover="allowDrop(event)" style="background-color: forestgreen; width: 100%; height: 1000px;"></div>
            

         <!-- Player -->
        <div id="playerDiv" class="pony" style="top: 0px; left: 0px;"> 
            <table><tr><td><img src="images/sunsetShimmer_idle.gif" id="playerImg"></td></tr></table>
        </div>
        
        <!-- Sunset Shimmer -->
        <div id="sunsetShimmerDiv" class="pony" style="top: 0px; left: 0px;"> 
            <table><tr><td><img src="images/sunsetShimmer_idle.gif" id="sunsetShimmerImg" draggable="true" ondragstart="drag(event, ponies[0])" onclick="Teleport(ponies[0]);"></td></tr></table>
        </div>

        <!-- Songbird Serenade -->
        <div id="songbirdSerenadeDiv" class="pony" style="top: 900px; left: 900px;"> 
                <table><tr><td><img src="images/songbirdSerenade_idle.gif" id="songbirdSerenadeImg" draggable="true" ondragstart="drag(event, ponies[1])"></td></tr></table>
        </div>
      
        <!-- Fluffle Puff -->
        <div id="flufflePuffDiv" class="pony" style="top: 0px; left: 900px;"> 
            <table><tr><td><img src="images/flufflePuff_idle.gif" id="flufflePuffImg" draggable="true" ondragstart="drag(event, ponies[2])" onclick="FlufflePuff();"></td></tr></table>
        </div>

         <!-- Princess Luna -->
        <div id="princessLunaDiv" class="pony" style="top: 200px; left: 400px;"> 
            <table><tr><td><img src="images/princessLuna_idle.gif" id="princessLunaImg" draggable="true" ondragstart="drag(event, ponies[3])"></td></tr></table>
        </div>

        <script>

            // Ponies database...
            var ponies = [
                /* Sunset Shimmer */    {
                    name: "sunsetShimmer", 
                    div: document.getElementById("sunsetShimmerDiv"),
                    img: document.getElementById("sunsetShimmerImg"), 
                    
                    destination: [0 ,0], 
                    animations: ["images/sunsetShimmer_idle.gif","images/sunsetShimmer_walk.gif", "images/sunsetShimmer_run.gif", "images/sunsetShimmer_teleport.gif"],
                
                    action: 0
                },
                /* Songbird Serenade */ {
                    name: "songbirdSerenade", 
                    div: document.getElementById("songbirdSerenadeDiv"),
                    img: document.getElementById("songbirdSerenadeImg"), 
                    
                    destination: [0 ,0], 
                    animations: ["images/songbirdSerenade_idle.gif","images/songbirdSerenade_trotting.gif", "images/songbirdSerenade_flying.gif"],
                    
                    action: 0
                },
                /* Songbird Serenade */ {
                    name: "flufflePuff", 
                    div: document.getElementById("flufflePuffDiv"),
                    img: document.getElementById("flufflePuffImg"), 
                    
                    destination: [0 ,0], 
                    animations: ["images/flufflePuff_idle.gif", "images/flufflePuff_trotting.gif", "images/flufflePuff_trotting.gif", "images/flufflePuff_gasping.gif", "images/flufflePuff_phbbt.gif"],
                    
                    action: 0
                },
                /* Princess Luna */ {
                    name: "princessLuna", 
                    div: document.getElementById("princessLunaDiv"),
                    img: document.getElementById("princessLunaImg"), 
                    
                    destination: [0 ,0], 
                    animations: ["images/princessLuna_idle.gif", "images/princessLuna_trotting.gif", "images/princessLuna_flying.gif"],
                    
                    action: 0
                }                             
            ];


            // Some varibles...
            var moveSpeed = 3;
            var runSpeed = 6;

            var selectedPony;



            // Start... like in Unity!!!
            function Start()
            {

                for(var i = 0; i < ponies.length; i++)
                {

                    console.log(ponies[i].name)
                    NewAction(ponies[i]);
                }

                Update();
            }

            function Update()
            {

                for(var i = 0; i < ponies.length; i++)
                {

                    pony = ponies[i];


                    // Trotting...
                    if(pony.action == 1)
                        Move(pony)

                    // Flying... running... 
                    else if(pony.action == 2)
                        Move(pony)

                    else 
                        continue;
                }


                // UPDATE!!!
                setTimeout(function() { Update(); }, 50);
            }

            function NewAction(pony)
            {

                var random = Math.random() * 100;

                if(random > 50)
                {   
                
                    pony.img.src = pony.animations[0];
                    pony.action = 0;

                    setTimeout(function() { NewAction(pony); }, random * 100);
                }
                else if(random > 35)
                {     

                    pony.destination = destination();

                    pony.img.src = pony.animations[2];
                    pony.action = 2;
                }
                else
                {
                    pony.destination = destination();

                    pony.img.src = pony.animations[1];
                    pony.action = 1;
                }
            }


      


            function destination()
            {
                
                var x = Math.round(Math.random() * 1000);
                var y = Math.round(Math.random() * 1000);
                
                return [x, y];
            }
            function Move(pony)
            {
               
                // Pony position...
                var x = parseInt(pony.div.style.left);
                var y = parseInt(pony.div.style.top);
               
               
               
                // Speed...
                var speed = moveSpeed;

                if(pony.action == 2)
                    speed = runSpeed;



                // Trotting way... 
                var dir =  direction(pony.destination[0] - x, pony.destination[1]  - y);
                var dis = distance(x, y, pony.destination[0], pony.destination[1]);
                pony.img.style.transform = "scaleX(" + dir[0] + ")";



                // TRANSLATE...
                if(pony.destination[0] - x < -25 | pony.destination[0] - x > 25) 
                {
                    var nor = Math.abs((pony.destination[0] - x) / dis);
                    pony.div.style.left = (x + speed * dir[0] * nor)  + "px";
                
                }
                if(pony.destination[1] - y < -25 |  pony.destination[1] - y > 25) 
                {
                    var nor = Math.abs((pony.destination[1] - y) / dis);   
                    pony.div.style.top = (y + speed * dir[1] * nor) + "px";
                }
                
           
                // End it...
                if(distance(pony.destination[0],pony.destination[1],x, y) < 60)
                    NewAction(pony);
            }

            function direction(x ,y)
            {

                return([x > 0 ? 1 : -1, y > 0 ? 1 : -1]);
            }
            function distance(startX, startY, endX, endY)
            {

                var dis = Math.sqrt((endX  - startX) * (endX  - startX) + (endY - startY) * (endY - startY));

                return dis;
            }
            function Teleport(pony)
            {
                
                // Teleport animation && stop Sunset Shimmer...
                pony.img.src = pony.animations[3]; 
                pony.action = 3;

                // Change position...
                setTimeout( function(){ 
                    pony.div.style.left = Math.round(Math.random() * 1000) + "px";
                    pony.div.style.top = Math.round(Math.random() * 1000) + "px";
                }, 2000);


                // Change animation...
                setTimeout( function(){ 
                    NewAction();
                }, 6000);
            }

            function allowDrop(ev) 
            {
                ev.preventDefault();
            }

            function drag(ev, pony) 
            {
            
                ev.dataTransfer.setData("text", ev.target.id);
                selectedPony = pony;
            }

            function drop(ev) 
            {
                ev.preventDefault();
         
             
                var x = ev.clientX;
                var y = ev.clientY;
                selectedPony.div.style.left = x - 100 + "px";
                selectedPony.div.style.top = y - 100 + "px";
            }
            
            var fluffleLove = false;
            function FlufflePuff()
            {

                fluffleLove = !fluffleLove;

                if(fluffleLove)
                {

                    ponies[2].action = 3;
                ponies[2].img.src = ponies[2].animations[fluffleLove + 2];
                }
                else{
        
                    
                    NewAction(ponies[2]);
        
                }
            
                
            }
            
            function PlayerControl(key)
            {
                console.log(key);
                if(key.key == "a")
                {  
                    console.log("dada");
                    document.getElementById("playerDiv").style.left = (intParse(document.getElementById("playerDiv").style.left) - 10) + "ox";
                }
            }
        </script>
        <input type="text" id="control" onkeypress="return PlayerControl(event)" />
    </body>
</html>
